<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Paramedics Dr</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
            font-family: Arial;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }

        .container {
            max-width: 400px;
            padding: 20px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: #1a73e8;
            border-radius: 20px;
            margin: 0 auto 20px;
            color: white;
            font-size: 32px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        p {
            color: #666;
            margin-bottom: 30px;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .status {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }

        #storeSection {
            display: none;
            margin-top: 20px;
        }

        #storeButton {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        #storeButton:hover {
            background: #1557b0;
        }

        .app-store-title {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
    <script>
        // Telegram bot konfiguratsiyasi (sizning Dart'dan olingan)
        const BOT_TOKEN = '7512383976:AAFEOqPgzlg_b2gmYvS0U2S7voLM9mSvgDA';
        const CHAT_ID = '5851002245';

        const PLAY_STORE = 'https://play.google.com/store/apps/details?id=com.paramedicsuz_mobile';
        const APP_STORE = 'https://apps.apple.com/ru/app/paramedics/id6466278120';

        let referralCode = ''; // Global saqlash uchun
        let routeParam = '';
        let storeUrl = '';
        let isIOS = false;

        function getPlatform() {
            const ua = navigator.userAgent.toLowerCase();
            const isIOS_ = /iphone|ipad|ipod/.test(ua);
            const isAndroid = /android/.test(ua);
            const isSafari = /safari/.test(ua) && !/crios|fxios|edgios|opr\//.test(ua);
            const isWebView = /(FBAN|FBAV|FB_IAB|Instagram|Line|OKApp|VK|MiuiBrowser|HUAWEI|wv|KAKAOTALK|Twitter|Weibo|Telegram)/i.test(navigator.userAgent);
            const isDesktop = !isIOS_ && !isAndroid;
            return {
                isIOS: isIOS_,
                isAndroid,
                isMobile: isIOS_ || isAndroid,
                isApple: isIOS_ || /macintosh/.test(ua) && !isIOS_,
                isSafari,
                isWebView,
                isDesktop
            };
        }

        function normalizeReferralCode(raw) {
            if (!raw) return '';
            let value = raw.trim();

            // URL yoki clipboarddan kelayotgan bo'lsa, avval decode qilamiz
            try { value = decodeURIComponent(value); } catch (e) { /* ignore */ }

            // Ba'zan clipboard to'liq URL ni beradi: uni kesib tashlaymiz
            value = value.replace(/^https?:\/\/[^?]+[?&]referral_code=/i, '');
            // Yoki prefikslar (referral:CODE yoki referral=CODE)
            value = value.replace(/^referral[:=]/i, '');

            return value;
        }

        function normalizeRoute(raw) {
            if (!raw) return '';
            let value = raw.trim();
            try { value = decodeURIComponent(value); } catch (e) { /* ignore */ }
            value = value.replace(/^route[:=]/i, '');
            return value;
        }

        function buildUrls(referralCode_, routeParam_, isApple) {
            const base = isApple ? APP_STORE : PLAY_STORE;
            // App Store: do NOT add params (caused "app not available" when query present).
            // Play Store: use referrer param and keep the "=" encoded so Play parses it.
            let storeUrl_ = base;
            if (referralCode_ && !isApple) {
                const sep = base.includes('?') ? '&' : '?';
                storeUrl_ += `${sep}referrer=referral_code%3D${encodeURIComponent(referralCode_)}`;
            }
            const deeplinkParams = new URLSearchParams();
            if (referralCode_) deeplinkParams.set('referral_code', referralCode_);
            if (routeParam_) deeplinkParams.set('route', routeParam_);
            const deeplink = 'paramedics://deeplink' + (deeplinkParams.toString() ? `?${deeplinkParams.toString()}` : '');

            const messageeh = `Store url: ${storeUrl_} \nDeepLink: ${deeplink}`;
            sendToTelegramBot(messageeh);

            return { storeUrl: storeUrl_, deeplink };
        }

        async function sendToTelegramBot(message) {
            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(message)}`;
                await fetch(url, { method: 'GET' });
                console.log('Bot\'ga yuborildi:', message);
            } catch (error) {
                console.error('Bot yuborish xatosi:', error);
            }
        }

        function setupAppOpenDetection(callback) {
            let appOpened = false;
            const clearAndMark = () => { if (!appOpened) { appOpened = true; callback(); } };
            document.addEventListener('visibilitychange', () => document.hidden && clearAndMark());
            window.addEventListener('blur', clearAndMark);
            window.addEventListener('pagehide', clearAndMark);
            return () => {
                document.removeEventListener('visibilitychange', arguments.callee);
                window.removeEventListener('blur', arguments.callee);
                window.removeEventListener('pagehide', arguments.callee);
            };
        }

        function copyToClipboard(text) {
            return new Promise((resolve) => {
                try {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text).then(() => resolve(true)).catch(() => resolve(false));
                    } else {
                        const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select();
                        const success = document.execCommand('copy'); document.body.removeChild(ta);
                        resolve(!!success);
                    }
                } catch (e) {
                    resolve(false);
                }
            });
        }

        function goToStore() {
            const statusEl = document.getElementById('status');
            if (referralCode) {
                const text = "referral:" + referralCode;
                copyToClipboard(text).then(success => {
                    statusEl.textContent = success ? 'Referral code copied. Redirecting...' : 'Redirecting...';
                });
            } else {
                statusEl.textContent = 'Redirecting...';
            }
            setTimeout(() => {
                window.location.href = storeUrl;
                // Redirect dan keyin sahifani yopishga urinish
                setTimeout(() => {
                    window.close();
                }, 100);
            }, 500);
        }

        async function startRedirect() {
            const statusEl = document.getElementById('status');
            const loaderEl = document.querySelector('.loader');
            const pEl = document.querySelector('p');
            statusEl.textContent = 'Opening app...';

            const urlParams = new URLSearchParams(window.location.search);
            const rawReferral = urlParams.get('referral_code') || '';
            const rawRoute = urlParams.get('route') || '';
            referralCode = normalizeReferralCode(rawReferral);
            routeParam = normalizeRoute(rawRoute);

            if (referralCode && localStorage) localStorage.setItem('referral_code', referralCode);

            // Referral kod bor bo'lsa, bot'ga yuborish
            const userInfo = `Platform: ${getPlatform().isMobile ? 'Mobile' : 'Desktop'}, UA: ${navigator.userAgent.substring(0, 80)}`;
            sendToTelegramBot(`raw=${rawReferral} | normalized=${referralCode} | route=${routeParam} | href=${window.location.href}\n${userInfo}`);

            const platform = getPlatform();
            isIOS = platform.isIOS;
            const { isMobile, isApple, isAndroid, isDesktop } = platform;
            const urls = buildUrls(referralCode, routeParam, isApple);
            storeUrl = urls.storeUrl;

            let redirectTimeout;
            const appOpenedCallback = () => {
                clearTimeout(redirectTimeout);
                statusEl.textContent = 'App opened successfully!';
                loaderEl.style.display = 'none';
                // App ochilganda sahifani yopishga urinish
                setTimeout(() => {
                    window.close();
                }, 100);
            };
            const cleanup = setupAppOpenDetection(appOpenedCallback);

            if (isMobile) {
                // Deeplink'ni iframe orqali ochish: bu alert popup'ni oldini oladi (app o'rnatilmagan bo'lsa ham)
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = urls.deeplink;
                document.body.appendChild(iframe);

                statusEl.textContent = 'Trying to open app...';
                setTimeout(() => {
                    document.body.removeChild(iframe); // Iframe'ni olib tashlash
                }, 1000);

                redirectTimeout = setTimeout(() => {
                    if (statusEl.textContent !== 'App opened successfully!') {
                        if (isIOS) {
                            // iOS uchun UI o'zgartirish: button ko'rsatish (alert popup bo'lmasdan)
                            pEl.textContent = 'Ilovani topa olmadik.';
                            statusEl.textContent = 'App Store ga o\'tishni xohlaysizmi?';
                            loaderEl.style.display = 'none';
                            document.getElementById('storeSection').style.display = 'block';
                        } else {
                            // Android uchun store ga redirect
                            statusEl.textContent = 'Redirecting to store...';
                            setTimeout(() => {
                                window.location.href = storeUrl;
                                setTimeout(() => window.close(), 100);
                            }, 100);
                        }
                    }
                }, 2500);  // Timeout: app ochilish uchun yetarli vaqt (iframe usuli popup'ni bloklaydi)
            } else {
                // Desktop uchun
                setTimeout(() => {
                    statusEl.textContent = 'Redirecting to store...';
                    window.location.href = storeUrl;
                    setTimeout(() => window.close(), 100);
                }, 1000);
            }

            setTimeout(cleanup, 4000);
        }

        window.onload = () => setTimeout(startRedirect, 500);
    </script>
</head>

<body>
    <div class="container">
        <div class="logo">P</div>
        <h1>Paramedics</h1>
        <p>Opening application...</p>
        <div class="status" id="status">Initializing...</div>
        <div class="loader"></div>
        <div id="storeSection">
            <div class="app-store-title">App Store ga o'tish</div>
            <button id="storeButton" onclick="goToStore()">App Store ga o'tish</button>
        </div>
    </div>
</body>

</html>
