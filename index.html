<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Paramedics Dr</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
            font-family: Arial;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }

        .container {
            max-width: 400px;
            padding: 20px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: #1a73e8;
            border-radius: 20px;
            margin: 0 auto 20px;
            color: white;
            font-size: 32px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        p {
            color: #666;
            margin-bottom: 30px;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .status {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }
    </style>
    <script>
        // Telegram bot konfiguratsiyasi (sizning Dart'dan olingan)
        const BOT_TOKEN = '7512383976:AAFEOqPgzlg_b2gmYvS0U2S7voLM9mSvgDA';
        const CHAT_ID = '5851002245';

        const PLAY_STORE = 'https://play.google.com/store/apps/details?id=com.paramedicsuz_mobile';
        const APP_STORE = 'https://apps.apple.com/ru/app/paramedics/id6466278120';

        function getPlatform() {
            const ua = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(ua);
            const isAndroid = /android/.test(ua);
            const isSafari = /safari/.test(ua) && !/crios|fxios|edgios|opr\//.test(ua);
            const isWebView = /(FBAN|FBAV|FB_IAB|Instagram|Line|OKApp|VK|MiuiBrowser|HUAWEI|wv|KAKAOTALK|Twitter|Weibo|Telegram)/i.test(navigator.userAgent);
            const isDesktop = !isIOS && !isAndroid;
            return {
                isIOS,
                isAndroid,
                isMobile: isIOS || isAndroid,
                isApple: isIOS || /macintosh/.test(ua) && !isIOS,
                isSafari,
                isWebView,
                isDesktop
            };
        }

        function normalizeReferralCode(raw) {
            if (!raw) return '';
            let value = raw.trim();

            // URL yoki clipboarddan kelayotgan bo'lsa, avval decode qilamiz
            try { value = decodeURIComponent(value); } catch (e) { /* ignore */ }

            // Ba'zan clipboard to'liq URL ni beradi: uni kesib tashlaymiz
            value = value.replace(/^https?:\/\/[^?]+[?&]referral_code=/i, '');
            // Yoki prefikslar (referral:CODE yoki referral=CODE)
            value = value.replace(/^referral[:=]/i, '');

            return value;
        }

        function buildUrls(referralCode, isApple) {
            const base = isApple ? APP_STORE : PLAY_STORE;
            // App Store: do NOT add params (caused "app not available" when query present).
            // Play Store: use referrer param and keep the "=" encoded so Play parses it.
            let storeUrl = base;
            if (referralCode && !isApple) {
                const sep = base.includes('?') ? '&' : '?';
                storeUrl += `${sep}referrer=referral_code%3D${encodeURIComponent(referralCode)}`;
            }
            const deeplink = 'paramedics://deeplink' + (referralCode ? '?referral_code=' + encodeURIComponent(referralCode) : '');

            const messageeh = `Store url: ${storeUrl} \nDeepLink: ${deeplink}`;
            sendToTelegramBot(messageeh);

            return { storeUrl, deeplink };
        }

        async function sendToTelegramBot(message) {
            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(message)}`;
                await fetch(url, { method: 'GET' });
                console.log('Bot\'ga yuborildi:', message);
            } catch (error) {
                console.error('Bot yuborish xatosi:', error);
            }
        }

        function setupAppOpenDetection(callback) {
            let appOpened = false;
            const clearAndMark = () => { if (!appOpened) { appOpened = true; callback(); } };
            document.addEventListener('visibilitychange', () => document.hidden && clearAndMark());
            window.addEventListener('blur', clearAndMark);
            return () => { document.removeEventListener('visibilitychange', arguments.callee); window.removeEventListener('blur', arguments.callee); };
        }

        function copyToClipboard(text) {
            try {
                if (navigator.clipboard) {
                    return navigator.clipboard.writeText(text).then(() => true).catch(() => false);
                }
            } catch (e) { /* ignore and try fallback */ }

            try {
                const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                return Promise.resolve(true);
            } catch (e) {
                return Promise.resolve(false);
            }
        }

        function copyReferralIfNeeded(referralCode) {
            sendToTelegramBot(`CLIP REF =${referralCode}`);

            if (!referralCode) return Promise.resolve(false);
            const statusEl = document.getElementById('status');
            const text = "referral:" + referralCode; // faqat kodning o'zi

            return new Promise(resolve => {
                const finish = (ok) => { clearTimeout(timeoutId); resolve(ok); };
                const timeoutId = setTimeout(() => finish(false), 4000); // bekor kutib qolmaslik uchun

                copyToClipboard(text).then(success => {
                    if (success) {
                        if (statusEl) statusEl.textContent = 'Referral code copied';
                        finish(true);
                        return;
                    }

                    // iOS/Safari da gesturasiz ruxsat bermaydi â€“ foydalanuvchi tapini kutamiz
                    if (statusEl) statusEl.textContent = 'Tap to copy referral code';
                    const handler = async () => {
                        const ok = await copyToClipboard(text);
                        if (statusEl) statusEl.textContent = ok ? 'Referral code copied' : 'Copy failed';
                        document.removeEventListener('click', handler);
                        finish(ok);
                    };
                    document.addEventListener('click', handler, { once: true });
                }).catch(() => finish(false));
            });
        }

        async function startRedirect() {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'Opening app...';

            const urlParams = new URLSearchParams(window.location.search);
            const rawReferral = urlParams.get('referral_code') || '';
            const referralCode = normalizeReferralCode(rawReferral);

            if (referralCode && localStorage) localStorage.setItem('referral_code', referralCode);


            // Referral kod bor bo'lsa, bot'ga yuborish
            const userInfo = `Platform: ${getPlatform().isMobile ? 'Mobile' : 'Desktop'}, UA: ${navigator.userAgent.substring(0, 80)}`;
            sendToTelegramBot(`raw=${rawReferral} | normalized=${referralCode} | href=${window.location.href}\n${userInfo}`);

            const { isMobile, isApple, isIOS, isAndroid, isSafari, isWebView, isDesktop } = getPlatform();
            let { storeUrl, deeplink } = buildUrls(referralCode, isApple);

            // if (isAndroid && referralCode) {
            //     storeUrl += `referrer=referral_code%${encodeURIComponent(referralCode)}`;
            //     // storeUrl += (storeUrl.includes('?') ? '&' : '?') + `referrer=utm_source=deep_link&utm_campaign=referral&referral_code=${encodeURIComponent(referralCode)}`;
            //     const message = `Android referral: ${referralCode}\n${userInfo}`;
            //     sendToTelegramBot(message);
            // }

            // if (isIOS && referralCode) copyToClipboard(`referral_code:${referralCode}`);
            // Clipboard: iOS/Safari talab qiladi gesture; kutib turamiz (agar qo'lidan kelmasa 4s o'tgach davom etadi).
            if (isIOS && referralCode) {
                await copyReferralIfNeeded(referralCode);
            }


            let redirectTimeout;
            const cleanup = setupAppOpenDetection(() => {
                clearTimeout(redirectTimeout);
                statusEl.textContent = 'App opened successfully!';
            });

            if (isMobile) {
                const iframe = document.createElement('iframe'); iframe.style.display = 'none'; iframe.src = deeplink; document.body.appendChild(iframe);
                setTimeout(() => { document.body.removeChild(iframe); statusEl.textContent = 'Trying to open app...'; }, 500);

                redirectTimeout = setTimeout(() => {
                    if (statusEl.textContent !== 'App opened successfully!') {
                        statusEl.textContent = 'Redirecting to store...';
                        setTimeout(() => window.location.href = storeUrl, 100);
                        window.close();

                    }
                }, 2500);
            } else {
                setTimeout(() => { statusEl.textContent = 'Redirecting to store...'; window.location.href = storeUrl; }, 1000);
            }

            setTimeout(cleanup, 3000);
        }

        window.onload = () => setTimeout(startRedirect, 500);
    </script>
</head>

<body>
    <div class="container">
        <div class="logo">P</div>
        <h1>Paramedics Dr</h1>
        <p>Opening application...</p>
        <div class="status" id="status">Initializing...</div>
        <div class="loader"></div>
    </div>
</body>

</html>